---

name: Push to Ansible Galaxy

on:
  push:
    tags:
      - "*" # optional enger: "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish (e.g. v1.2.3). Required for manual runs."
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: galaxy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  galaxy:
    name: Publish to Galaxy
    runs-on: ubuntu-22.04

    steps:
      - name: Resolve ref (tag only)
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "ref=refs/tags/${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            # push-tag event
            if [[ "${GITHUB_REF}" != refs/tags/* ]]; then
              echo "This workflow is tag-only (refs/tags/*). Got: ${GITHUB_REF}" >&2
              exit 1
            fi
            echo "ref=${GITHUB_REF}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout the codebase (tag ref)
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.ref.outputs.ref }}
          fetch-depth: 0

      - name: Publish
        uses: robertdebock/galaxy-action@1.2.1
        with:
          galaxy_api_key: ${{ secrets.galaxy_api_key }}
