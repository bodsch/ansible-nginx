#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}

{% import 'jinja_macros.j2' as tpl with context %}

{% if item.key == "default" %}
server {
  server_name   _;
  listen        {{ item.value.listen | default(80) }} default_server;
  {% if item.value.ipv6 is defined and
        item.value.ipv6 | default('true') | bool %}
  listen        [::]:{{ item.value.listen | default(80) }};
  {% endif %}
  return        444;

  {{ tpl.vhost_logfile(item.logfiles | default({}), item.key) | indent(0, first=False) }}
}

server {
  server_name   _;
  listen        {{ item.value.listen_ssl | default(443) }} ssl http2 default_server;
  {% if item.value.ipv6 is defined and
        item.value.ipv6 | default('true') | bool %}
  listen        [::]:{{ item.value.listen_ssl | default(443) }} ssl http2 default_server;
  {% endif %}
  return        444;

  {{ tpl.vhost_logfile(item.logfiles | default({}), item.key) | indent(0, first=False) }}

  {{ tpl.vhost_certificates(item.value | default({}), item.key) | indent(0, first=False) }}
}

{% else %}
{# upstream configurations #}
{{ tpl.vhost_upstreams(item.value | default({})) | indent(0, first=False) }}

{# HTTP block ... including acme-challenge for letsencrypt #}
server {
  server_name
    {{ item.value.domains | join('\n') | indent(4, first=False) }};
  listen         {{ item.value.listen | default(80) }};
  {% if item.value.ipv6 is defined and
        item.value.ipv6 | default('true') | bool %}
  listen         [::]:{{ item.value.listen | default(80) }}; {% endif %}

  {{ tpl.vhost_logfile(item.logfiles | default({}), item.key) | indent(0, first=False) }}

  location /.well-known/acme-challenge {
    alias /var/www/{{ item.key }}/.well-known/acme-challenge;
  }

  location / {
    return         301 https://$server_name$request_uri;
  }
}
{# HTTPS block #}
server {
  server_name
    {{ item.value.domains | join('\n') | indent(4, first=False) }};
  listen         {{ item.value.listen | default(443) }} ssl http2;
  {% if item.value.ipv6 is defined and
        item.value.ipv6 | default('true') | bool %}
  listen         [::]:{{ item.value.listen | default(443) }} ssl http2;
  {% endif %}

  {{ tpl.vhost_logfile(item.logfiles | default({}), item.key) | indent(0, first=False) }}

  location /.well-known {
    alias /var/www/{{ item.key }}/.well-known;
  }

  {{ tpl.vhost_certificates(item.value | default({}), item.key) | indent(0, first=False) }}

  {{ tpl.vhost_locations(item.value | default({})) | indent(0, first=False) }}
}
{% endif %}
