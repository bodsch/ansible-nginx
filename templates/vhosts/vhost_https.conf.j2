#jinja2: trim_blocks: True, rstrip_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}
#
# {{ item.key }}

{%- import 'jinja_macros.j2' as tpl with context %}
{%- set _upstreams = item.value.upstreams | default({}) %}
{%- set _logfiles = item.value.logfiles | default({}) %}
{%- set _ssl = item.value.ssl | default({}) %}
{%- set _locations = item.value.locations | default({}) %}
{%- set _listen = item.value.listen | default(['443 ssl http2']) %}

{% if item.key == "default" %}
{# DEFAULT vhost #}
server {
  server_name   _;
  {{ tpl.vhost_listen(80, True) | indent(0, first=False)  }}
  return        444;
  {{ tpl.vhost_logfile(_logfiles, item.key) | indent(0, first=False) -}}
}
{% endif %}

{% if _upstreams | count > 0 %}
{{ tpl.vhost_upstreams(_upstreams | default({})) }}
{% endif %}
{% if item.value.redirect is defined and
      item.value.redirect.from_port is defined %}
  {% if _listen | type == "str" %}
    {% set _listen_port = _listen | default('443 ssl http2') | regex_replace('(http2|ssl|quic|reuseport)','') %}
  {% endif %}
  {% if _listen | type == "list" %}
    {% set _listen_port = _listen | join(' ') | default('443') | regex_replace('(http2|ssl|quic|reuseport)','') %}
  {% endif %}

server {
  server_name
    {{ item.value.domains | default(['localhost']) | join('\n') | indent(4, first=False) }};

  {{ tpl.vhost_listen(item.value.redirect.from_port | default(80)) | indent(0, first=False)  }}
  {{ tpl.vhost_logfile(_logfiles, item.key) | indent(0, first=False) }}
  location ^~ /.well-known/acme-challenge/ {
    allow all;
    default_type "text/plain";
    root  {{ nginx_acme.challenge_directory }};
  }
  location = /.well-known/acme-challenge/ {
    return 404;
  }
  location / {
    return         301 https://$server_name$request_uri;
  }
}
{% endif %}

server {
  server_name
    {{ item.value.domains | join('\n') | indent(4, first=False) }};

  {{ tpl.vhost_listen(_listen | default(443)) | indent(0, first=False)  }}
  {{ tpl.vhost_logfile(_logfiles, item.key) | indent(0, first=False) }}
  {{ tpl.vhost_certificates(_ssl, item.key) | indent(0, first=False) }}
  {{ tpl.vhost_locations(_locations) | indent(0, first=False) -}}
}
